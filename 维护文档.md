# MAINTENANCE.md — 选课与绩点记录系统维护说明（最终版本）

## 1. 项目目标与运行形态

本项目是一个本地桌面 GUI 程序，用于：

- 从 `config.json` 读取课程库与选课/绩点记录；
- 支持按学期（含夏季）选课、删除、录入绩点；
- 自动计算：学期 GPA、总 GPA、专业课 GPA、每年 GPA；
- 显示培养计划模块学分进度表（总学分/已选/已修/剩余）；
- 将所有变更保存回 `config.json`。

程序采用三层结构：

- `main.py`：启动层（入口）
- `gui.py`：表现层（GUI 与交互）
- `core.py`：业务/数据层（规则、统计、持久化、数据结构）

------

## 2. 文件结构与职责

### 2.1 main.py（入口文件）

**职责：** 只负责启动 GUI，不包含业务逻辑。

**典型内容：**

- `from gui import CourseSelectionApp`
- 创建 app 并 `mainloop()`

**维护要点：**

- 保持 main.py “薄”，不要把规则/计算逻辑写在这里；
- 若需要传递 config 路径参数，可在 main.py 里读取命令行参数并传入 `CourseSelectionApp(config_path)`。

------

### 2.2 gui.py（GUI 与交互层）

**职责：**

- 构建窗口与布局（左侧课程目录、右侧学期计划、底部进度表、摘要栏）；
- 绑定用户交互：双击添加课、按钮添加/删除、Backspace/Delete 删除、双击设置绩点、表头排序；
- 调用 core.py 提供的接口执行数据变更与统计；
- 调用 `save_to_config()` 将数据持久化。

#### 2.2.1 关键组件与布局（建议保持一致）

GUI 建议保持以下结构（便于用户理解与维护）：

1. 顶部工具栏（按钮）

- 打开配置 / 保存 / 另存为
- 自动加入全部必修
- 校验规则
- 可视化（若存在 viz.py 且导入成功）

1. 中间主体区：左右两栏

- **左侧：可选课程（按季节）**
  - Tab：秋/春/夏
  - 每个季节页内包含两张表：必修可选 / 选修可选
  - 支持：双击添加到右侧当前学期
- **右侧：选课计划与绩点（按实际学期）**
  - Tab：1秋、1春、1夏、2秋、2春、2夏、3秋、3春、3夏、4秋、4春、4夏
  - 每个 Tab 一张表：显示该学期已选课程及绩点
  - 支持：双击或按钮设置绩点；Backspace/Delete 删除选中课程

1. 底部：培养计划学分进度表（Treeview）

- 模块：思政/体育/专业必修/专业选修（可扩展更多模块）
- 列：培养计划总学分 / 已选学分 / 已修学分 / 剩余学分

1. 最底部摘要栏（Label）

- 已选总学分、专业选修学分、缺少必修数量
- 学期 GPA 列表
- 总 GPA / 专业课 GPA / 每年 GPA
- 每学期学分上限

#### 2.2.2 Treeview 创建规范（必须遵守）

Treeview 必须创建在它实际 grid 的父容器中，例如：

```python
wrap = ttk.Frame(tab)
wrap.grid(...)
tv = ttk.Treeview(wrap, ...)
tv.grid(row=0, column=0, sticky="nsew")
```

**禁止**：Treeview master 是 `tab`，但 grid 放在 `wrap` 的布局逻辑（会导致表格被覆盖、出现“空白表格”）。

#### 2.2.3 排序行为（表头点击排序）

GUI 层提供 Treeview 的通用排序绑定：

- 点击表头：按该列作为第一关键字排序
- 再次点击同列：升/降序切换
- 刷新表格数据后：应恢复用户当前排序状态（不打乱顺序）

维护时注意：

- refresh 函数中先保存 `tv._sort_state`，重建行后调用 `tv.restore_sort()`。

#### 2.2.4 学期 Tab（必须包含夏季）

右侧学期必须包含 `1夏/2夏/3夏/4夏`，否则夏季课程无法选课与录入绩点。

#### 2.2.5 键盘快捷删除

右侧学期表格要求支持：

- Backspace 删除选中课程
- Delete 删除选中课程（建议同时支持）

维护实现要点：

- `tv.focus_set()`：点击表格行后让表格获得焦点，否则键盘事件不触发；
- 删除动作统一调用同一删除函数，保持按钮删除与快捷键删除一致。

#### 2.2.6 GUI 调用 core 的接口契约（必须匹配）

GUI 依赖 core 的以下接口（见第 2.3 节给出签名说明）：

- 选课：`plan.add_course(course_id, actual_semester)`
- 删除：`plan.remove_course(course_id)`
- 学期课程：`plan.courses_in_semester(actual_semester)`
- 学期学分：`plan.semester_credits(actual_semester)`
- 绩点：`plan.set_gpa(course_id, gpa_or_none)`
- 学期 GPA：`plan.semester_gpa(actual_semester)`
- 总 GPA：`plan.overall_gpa()`
- 专业课 GPA：`plan.major_gpa()`
- 每年 GPA：`plan.yearly_gpa()`
- 学分进度表：`plan.credit_progress_rows(requirements_dict)`
- 规则校验：`plan.validate()`
- 自动加入必修：`plan.auto_add_all_required()`
- 持久化：`save_to_config(path, catalog, plan)` / `load_from_config(path)`

------

### 2.3 core.py（业务逻辑 / 数据层）

**职责：**

- 定义课程与选课记录数据结构；
- 管理课程目录与检索；
- 实现选课规则、删除、绩点校验；
- 实现学分进度统计与各种 GPA 统计；
- 从 `config.json` 读取并保存数据；
  -（可选）为可视化提供分组接口。

#### 2.3.1 数据结构

1. `Course`（课程元数据）

- `course_id: str` 唯一
- `name: str`
- `course_type: str` 取值：`"必修"` 或 `"选修"`
- `credits: float`
- `semester: str` 方案学期：支持 `1秋/2春/3夏` 或 `秋/春/夏`
- `hours: Optional[str]`
- `category: str` 模块分类（进度表与专业课 GPA 依赖它）

1. `PlanItem`（用户选课记录 + 绩点）

- `course_id: str`
- `actual_semester: str` 必须是 `1秋/1春/1夏/...`
- `gpa: Optional[float]` 0~4.0 或 None

#### 2.3.2 Catalog（课程目录）

职责：

- 用 `course_id` 索引课程；
- 提供按季节（秋/春/夏）筛选并按类型分组的能力；

关键方法：

- `get(course_id) -> Course`
- `all() -> List[Course]`
- `required_courses() -> List[Course]`
- `offered_in_by_type(season) -> {"必修": [...], "选修": [...]}`

#### 2.3.3 EnrollmentPlan（选课计划 + 统计）

职责：

- 选课/删除；
- 学期课程查询；
- GPA 录入校验；
- GPA 统计（学期/总/专业课/每年）；
- 学分进度统计；
- 自动加入必修；
- 规则校验。

**核心规则（当前版本约定）：**

1. 允许跨年级选课：
   只要课程的“季节”匹配目标实际学期季节即可。例如：

- 课程方案学期为 `2秋` 或 `秋`，都归属于“秋季课程”
- 你可以把它添加到 `1秋` 或 `3秋`（由用户选择实际修读学期）

1. 学期学分上限：
   添加课程时，若该实际学期已选学分 + 新课学分 > `term_credit_limit`，拒绝添加。
2. 绩点范围：
   GPA 必须在 [0.0, 4.0]，或留空（None）。
3. “已修学分”的口径：
   默认 `已修学分 = gpa 已填写的课程学分`。

#### 2.3.4 EnrollmentPlan 对外接口签名（GUI 依赖）

建议 core.py 保持以下接口稳定：

- 选课/删课
  - `add_course(course_id: str, actual_semester: str) -> None`
  - `remove_course(course_id: str) -> None`
  - `has_course(course_id: str) -> bool`
- 学期查询
  - `courses_in_semester(actual_semester: str) -> List[Course]`
  - `semester_credits(actual_semester: str) -> float`
- GPA 录入/查询
  - `set_gpa(course_id: str, gpa: Optional[float]) -> None`
  - `get_gpa(course_id: str) -> Optional[float]`
- GPA 统计（学分加权）
  - `semester_gpa(actual_semester: str) -> (Optional[float], int)`
  - `overall_gpa() -> (Optional[float], int)`
  - `major_gpa(major_categories: Optional[set[str]] = None) -> (Optional[float], int)`
  - `yearly_gpa() -> Dict[int, (Optional[float], int)]`

> 口径说明：这些函数返回 `(avg_or_none, missing_count)`
> 如果统计范围内存在未填 GPA，则 avg 为 None，missing_count 为缺失门数。

- 学分进度（培养计划模块）
  - `credit_progress_rows(requirements: Dict[str, float]) -> List[Dict[str, ...]]`
    - 每行字段：`category, required, selected, completed, remaining`
- 规则校验 / 自动选必修
  - `validate() -> List[str]`
  - `auto_add_all_required() -> None`
- 可视化（若 viz.py 需要）
  - `grouped() -> Dict[str, List[Course]]`
    - 以实际学期为 key

#### 2.3.5 config.json 读写接口

core.py 提供：

- `load_from_config(path) -> (Catalog, EnrollmentPlan)`
- `save_to_config(path, catalog, plan) -> None`

**兼容性要求：**

- 若 `courses` 条目缺少 `category`，应能用默认课程库按 `course_id` 自动补齐（推荐在 load 时完成）。
- 读取后写回时应包含完整字段，减少后续“未分类”问题。

#### 2.3.6 培养方案默认课程库（_default_courses）

`_default_courses()` 用于：

- 当 config 不存在时生成初始课程库；
- 为旧 config 的课程条目补全 `category/semester/hours` 元数据（若启用迁移逻辑）。

维护时注意：

- `course_id` 必须唯一；
- 若同名课程在不同学期开设且原 `course_id` 相同，需拆分（例如 `形势与政策` 秋/春拆成不同 id）。

------

## 3. config.json 的维护规范

### 3.1 课程条目必须满足

- `course_id` 唯一；
- `credits` 可为小数；
- `semester` 可为 `1秋` 或 `秋`（允许不分年级，但建议仍优先填写具体学期以提升准确性）；
- `category` 必填（否则学分进度会落入“未分类”）。

### 3.2 Plan items 条目必须满足

- `actual_semester` 必须为 `N秋/N春/N夏`；
- `gpa` 允许缺省或 null。

------

## 4. 运行与发布建议

- 运行：`python main.py`
- 发布（可选）：建议使用 `pyinstaller` 打包，打包前确认：
  - `config.json` 放置策略（同目录、用户目录、或程序首次运行自动生成）
  - Tkinter 主题在 Windows 下的表现（字体、DPI）

------

## 5. 常见维护场景指引

### 5.1 新增学院培养方案

- 准备一份新的 `config_xxx.json`
- `courses` 写入该学院课程库（并设置合理 `category`）
- 运行程序，用“打开配置”加载该 json

### 5.2 修改学分进度模块

- 在 core.py 的 `PROGRAM_CREDIT_REQUIREMENTS` 增加/调整模块及总学分；
- 保证课程 `category` 对应模块名称一致；
- GUI 会自动按该字典顺序显示。

### 5.3 调整专业课范围（影响“专业课 GPA”）

- 维护 `major_gpa()` 中 `major_categories` 默认集合
- 或在 GUI 调用时传入自定义集合（若你后续加入“学院平台算专业课”等口径）

------

## 7. 变更约束（维护者必须遵守）

- GUI 不应直接读写 JSON：统一通过 core 的 `load_from_config/save_to_config`；
- GUI 不应自行计算 GPA/学分：统一调用 core；
- core 的对外接口变更必须同步修改 GUI 与 viz；
- `course_id` 永远作为主键，不允许出现重复，否则 Catalog 初始化应直接报错阻止运行。

------

如果你愿意把你当前最终版的三个文件内容（或至少 `main.py/gui.py/core.py` 的开头 import 和类/函数列表）贴出来，我可以把这份维护文件再“进一步精确到函数名与行级结构”，确保 100% 与你的最终文件一致（包括按钮名称、Tab 名称、字段名、可视化函数名等）。